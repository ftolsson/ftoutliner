<!doctype html>
<html>
	<head>
		<meta charset="utf-8"/>
		
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        
		<title>Beat Plugin Panel</title>

		<style type="text/css">
			* {
				box-sizing: border-box;
				cursor: default;
			}
			
			@font-face
			{
				font-family: 'Courier Prime';
				font-weight: normal;
				src: url("Courier Prime.ttf");
			}

			@font-face
			{
				font-family: 'Courier Prime';
				font-weight: bold;
				src: url("Courier Prime Bold.ttf");
			}
			@font-face
			{
				font-family: 'Courier Prime';
				font-style: italic;
				src: url("Courier Prime Italic.ttf");
			}
			@font-face
			{
				font-family: 'Courier Prime';
				font-weight: bold;
				font-style: italic;
				src: url("Courier Prime Bold Italic.ttf");
			}
			
			body {
				margin: 0;
				padding: 1rem;
				background-color: #f8f8f8;
				font-family: "Helvetica Neue", Helvetica, sans-serif;
				font-size: .8em;

				color: #333;

				user-select: none;
				-webkit-user-select: none;
			}
			body.dark {
				background-color: #151515;
				color: #eee;
			}

			.columns {
				width: 100%;
				display: flex;
				justify-content: space-between;
			}
			.column {
				width: 48%;
				display: flex;
				flex-direction: column;
			}
			.right {
				padding-left: 1em;
				width: 50%;
			}
			.left {
				padding-right: 1em;
				width: 50%;
			}
		
			section {
				margin: 0 auto 1rem auto;
			}

			h1, h2 {
				margin: 0 0 1rem 0;
				font-family: "Helvetica Neue", Helvetica, sans-serif;
				font-weight: normal;
				font-weight: 300;
				font-size: 2em;
			}
			h1 {
				margin-bottom: .5rem;
			}
			h2 {
				margin-top: 1rem;
				font-size: 1em;
				font-weight: bold;
			}
			p {
				line-height: 1.4em;
			}

			table { width: 100%; }
			td {
				font-size: .9em;
				padding: .35rem .25rem .35rem .25rem;
				border-bottom: 1px dotted #ddd;
			}

			.bar {
				color: #eee;
				background-color: rgb(0,129,239);
				display: flex;
				justify-content: center;
				align-items: center;
			}

			/* Beat colors */
			.red { background-color: rgb(239,0,73); color: white; }
			.blue { background-color: rgb(0,129,239); color: white; }
			.textBlue { color: rgb(0,129,239); }
			.green { background-color: rgb(0,223,121); color: white; }
			.pink { background-color: rgb(250,111,193); color: white; }
			.magenta { background-color: rgb(236,0,140); color: white; }
			.textMagenta { color: rgb(236,0,140); }
			.gray { background-color: gray; color: white; }
			.textGray { color: #ccc; }
			.purple { background-color: rgb(181, 32, 218); color: white; }
			.textPurple { color: rgb(181, 32, 218); }
			.prince { background-color: rgb(181, 32, 218); color: white; }
			.yellow { background-color: rgb(255, 162, 0); color: #333; }
			.cyan { background-color: rgb(7, 189, 236); color: white; }
			.teal { background-color: rgb(12, 224, 227); color: white; }
			.orange { background-color: rgb(255, 161, 13); color: white; }
			.textOrange { color: #006573; }
			.brown { background-color: rgb(169, 106, 7); color: white; }
			
			input[type="radio"] {
				margin: 0;
				border-radius: 50%;

				cursor: pointer;
				display: inline-block;
				
				width: 12px;
				height: 12px;
				border: solid 1px #bbb;
				
				position: relative;

				-webkit-appearance: none;
			}
			input[type="radio"]:focus {
				outline: none;
			}
			input[type="radio"]:after {
				background-color: transparent;
				border-radius: 25px;
				box-shadow: inset 0 0 0 0px hsla(0,0%,0%,.2),
							0 0px 0px hsla(0,0%,100%,.5);
				content: '';
				display: block;
				height: 8px;
				left: 1px;
				position: relative;
				top: 1px;
				width: 8px;
			}
			input[type="radio"]:checked:after {
				background-color: #888;
			}

		</style>
	</head>

	<body>
		<script crossorigin='anonymous'>			
			// Prevent native WKWebView context menu
			document.body.setAttribute('oncontextmenu', 'event.preventDefault();');
			
			// Override console methods.
			// This doesn't seem to work, though.
			function log(emoji, type, args) {
				if (type == "log") type = '';
				window.webkit.messageHandlers.log.postMessage(
															  `${emoji} ${type} ${Object.values(args)
															  .map(v => typeof(v) === "undefined" ? "undefined" : typeof(v) === "object" ? JSON.stringify(v) : v.toString())
															  .map(v => v.substring(0, 3000)) // Limit msg to 3000 chars
															  .join(", ")}`
															  )
			}

			let originalLog = console.log
			let originalWarn = console.warn
			let originalError = console.error
			let originalDebug = console.debug

			console.log = function() { log("", "log", arguments); originalLog.apply(null, arguments) }
			console.warn = function() { log("ðŸŸ ", "Warning:", arguments); originalWarn.apply(null, arguments) }
			console.error = function() { log("ðŸ”´", "Error:", arguments); originalError.apply(null, arguments) }
			console.debug = function() { log("ðŸ”µ", "Debug:", arguments); originalDebug.apply(null, arguments) }

			

			// Custom Beat HTML window object to allow some interaction with the host
			let Beat = {
				setData: function(data) {
					Beat.data = data;
				},
				data: null, // user-generated data to be passed back to plugin
				log: function(message) {
					window.webkit.messageHandlers.log.postMessage(message);
				},
				closeAndSendData: function() {
					sendBeatData();
				},
				call: function(value, ...parameters) {
					// We convert the value into a string, just as a safety measure
					window.webkit.messageHandlers.call.postMessage(evalToString(value, parameters))
				},
				callAndWait: function(value, ...parameters) {
					// We convert the value into a string, just as a safety measure
					return window.webkit.messageHandlers.callAndWait.postMessage(evalToString(value, parameters))
				},
				callback: function(value, param1, param2, param3) {
					let method
					let parameters
					let errorHandler
					
					if (param1 instanceof Function || typeof param1 === 'function') {
						method = param1
						parameters = param2
					}
					else {
						parameters = param1
						method = param2
					}
					
					if (param2 instanceof Function || typeof param2 === 'function') {
						errorHandler = param2
					} else {
						errorHandler = param3
					}
					 
					// We convert the value into a string, just as a safety measure
					var promise = window.webkit.messageHandlers.callAndWait.postMessage(evalToString(value, parameters))
					promise.then(
						(result) => {
							method(result)
						},
						(error) => {
							errorHandler()
						}
					)
				}
			};
			
			function evalToString (value, parameters) {
				// It's a string, do nothing, we'll just eval it
				if (value instanceof String || typeof value === 'string') {
					return value
				}
				
				if (value instanceof Function || typeof value === 'function') {
					// We'll make the value a self-executing function
					let params = ""
										
					// Handle parameters if needed
					if (parameters != null) {
						// Convert parameters to arguments by stringifying them
						for (const p of parameters) {
							// JS doesn't fucking care for my types, so let's misuse it.
							let pStr = p
							
							// Why the fuck do we need this? instanceof and typeof seem to return different values at times, so both have to be checked. Sigh.
							if (p instanceof String || p instanceof Array || p instanceof Object ||
								typeof p === "string" || typeof p === "array" || typeof p === Object) {
								pStr = JSON.stringify(pStr)
							}
							
							// Add to string and add commas
							params += pStr
							if (p != parameters[parameters.length - 1]) params += ',';
						}
					}
					
					value = "(" + value.toString() + ")(" + params + ")"
				} else {
					value = value.toString()
				}
				
				return value
			}
		
			function sendBeatData() {
				let inputs = document.querySelectorAll("[rel='beat']");
				let formData = [];
				
				for (const input of inputs) {
					let value = {
						name: input.name,
						value: input.value,
						checked: input.checked
					}
					formData.push(value);
				}
				
				let outputData = {
					inputData: formData,
					data: Beat.data
				}
				
				let data = JSON.stringify(outputData);
				window.webkit.messageHandlers.sendData.postMessage(data);
			}
		</script>
		
		
		<body>

<div id = "main">
	<p class="headline">Welcome to FTOutliner!<span class="versionnumber"></span></p>
	<br<br/>
	FTOutliner is a plugin for navigating, editing and getting a bird's eye view of your screenplay. If this is your first time here, don't be too confused. FTOutliner is meant to make your screenwriting life esier, so just keep it open next to your screenplay as you write and I'm sure you'll gradually find your own best way to use it.<br/><br/>
	<strong>Here's what's new in this version:</strong>
	<div id="changelog-wrapper">
		<div id="changelog"></div>
	</div>
	<!-- <strong>That's all!</strong> Let's go writing, both of us!<br/><br/><br/> -->
		<!--hr-->
		<ul>
		<!--strong><br/>Behavior Settings</strong><br/-->
		<li id="changeThis" style="width: max-content; margin-left: auto; margin-right: auto; padding-right: 40px"> 
			<input id="buttonFor-dontShowWelcomeWindowFor" + userDefault.ftoutlinerVersion type="checkbox">
			<label for="buttonFor-dontShowWelcomeWindowFor" + userDefault.ftoutlinerVersion>Don't show this dialog again for this version<span class="shortcut" style="float:right"></span></label>
			<!--span class="explanation">Unless there's something new to say that's really important.<br/>In which case sure, fine, go ahead.</span-->
		</li>
		</ul>

	<p><br/></p>
	<div class="dialogBottomButtonRow">
		<!-- <button class="generalButtonStyle" onclick="for (butn of $$('#advancedSettings input')){if(butn.checked){butn.click()}}">Revert to defaults</button> -->
		<button class="generalButtonStyle" onclick="Beat.call('Beat.custom.closeSecondWindow()')">Close</button>
	</div>
</div>

<script>

	//Dynamically adding version number to checkbox to automatically reset it when new version is released:

	window.addEventListener('load', function () {

		Beat.callAndWait(() => {
			let ftoutlinerVersion = Beat.getUserDefault("ftoutlinerVersion")
			let userDefault = Beat.getUserDefault("ftoutlinerObject")
			return(JSON.stringify([ftoutlinerVersion, userDefault]))
		})
		.then(
        	response => {
				
				response = JSON.parse(response)
				userDefault = JSON.parse(response[1])

				document.querySelector(".versionnumber").innerHTML = "v" + response[0]

				ftoutlinerVersion = response[0].replace(/\./g, "")
				
				let listItem = document.getElementById("changeThis")
					listItem.onclick = function(){
						toggleThis('dontShowWelcomeWindowFor' + ftoutlinerVersion, 'buttonFor-dontShowWelcomeWindowFor' + ftoutlinerVersion)
					}
					listItem.querySelector("input").id = "buttonFor-dontShowWelcomeWindowFor" + ftoutlinerVersion
					listItem.querySelector("label").setAttribute("for", "buttonFor-dontShowWelcomeWindowFor" + ftoutlinerVersion)
					listItem.querySelector("input").checked = userDefault['dontShowWelcomeWindowFor' + ftoutlinerVersion]
		},
        	error => { console.log("Error retrieving userDefault") }
    	)

		Beat.callAndWait(() => {
			let changelog = Beat.assetAsString("changelog")
			return(changelog)
		})
		.then(
        	response => {
				
				changelog = response
				document.querySelector("#changelog").innerHTML = markupToHTML(changelog)
				
		},
        	error => { console.log("Error retrieving changelog") }
    	)

	})

	//STARTUP SEQUENCE:

	var userDefault = {}
	var documentSetting = {}
    
    Beat.callAndWait(() => {
        let ftoutlinerObject = Beat.getUserDefault("ftoutlinerObject")
        return(ftoutlinerObject)
    })
    .then(
        response => { userDefault = JSON.parse(response)
			
			//Apply the correct checkbox states on open:
			for ([key, value] of Object.entries(userDefault)){					
					let button = document.getElementById("buttonFor-" + key)
						if(button){ 
							if(value == true) button.setAttribute("checked", true) 
						}
				}
		},
        error => { console.log("Error retrieving userDefault") }
    )

    Beat.callAndWait(() => {
        let ftoutlinerObject = Beat.getDocumentSetting("ftoutlinerObject")
        return ftoutlinerObject
    	})
		.then(
			response => { documentSetting = JSON.parse(response)
		
				//Apply the correct checkbox states on open:
					for ([key, value] of Object.entries(documentSetting)){					
						let button = document.getElementById("buttonFor-" + key)
							if(button){ 
								if(value == true) button.setAttribute("checked", true) 
							}
					}
			},
			error => { console.log("Error retrieving documentSetting") }
		)


	//FUNCTIONS:

	function toggleThis(settingName, settingButton, invertSelection){

		userDefault[settingName] = document.getElementById("buttonFor-" + settingName).checked
		
		let valueAsJSON = JSON.stringify(userDefault[settingName])
			Beat.call(`	Beat.custom.sendToMain("${settingName}", ${valueAsJSON}, "userDefault") `)

	}

	function markupToHTML(text){

		let html = document.createElement("div")

		text.split("\n").forEach(line => {

			line = line.replaceAll(/\*(\S.+?)\*/g, "<strong>$1</strong>")
			line = line.replaceAll(/\_(.+?)\_/g, "<i>$1</i>")
			// line = line.replaceAll(/\`(.+?)\`/g, "<code>$1</code>")
			line = line.replaceAll(/(?<!\\)\`(.+?)(?<!\\)\`/g, "<code>$1</code>").replaceAll(/\\`/g, "`")

			if(line.startsWith("#")){

				let headline = document.createElement("p")
					headline.classList.add("headline")
					headline.innerHTML = line.replace("#", "")
					html.appendChild(headline)

			}else if(line.startsWith("* ")){

				let listItem = document.createElement("li")
					listItem.classList.add("changelogList")
					listItem.innerHTML = line.replace("* ", "")
					html.appendChild(listItem)

			}else if(line.startsWith("  -")){

				let listItem = document.createElement("li")
					listItem.classList.add("changelogList")
					listItem.classList.add("level2")
					listItem.innerHTML = line.replace("  -", "")
					html.appendChild(listItem)

			}else{

				let paragraph = document.createElement("p")
					paragraph.innerHTML = line
					html.appendChild(paragraph)

			}

		})

		return(html.innerHTML)

	}


</script>

<style>

    :root{

        --menu-background: hsla(25, 64%, 96%, 1.00);/* rgb(240, 240, 240); /*was 232*/
	    --menu-border-color: #c1c1c1;
	    --menu-color: black; /*rgb(233,233,233);*/
	    --menu-hover-color: #027aff;

		--changelog-background: white

    }

    @media (prefers-color-scheme: dark) {

        :root{

            --menu-background: hsla(25, 10%, 24%, 1.00);
            --menu-border-color: rgb(81,81,81);
            --menu-color: rgb(233,233,233);

            --inkOnPaper: 0, 0%, 100%;
            --paperBehindInk: 0, 0%, 0%;

			--changelog-background: #222;

        }
    }

    body{

        background-color: var(--menu-background);
		color: var(--menu-color);

        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-size: 14px;
        font-weight: normal;
        line-height: 20px;

		padding: 20px 40px 20px 40px;

		overflow: hidden;

    }

	#changelog-wrapper{

		position: relative;
		overflow: hidden;
		width: auto;
		height: auto;
		margin: 20px 0px 20px 0px;
		border-radius: 4px;
		border: 1px solid transparent;

	}

	#changelog{

		position: relative;
		white-space: pre-wrap;

		background-color: var(--changelog-background);
		padding: 0px 30px 2px 30px;
		border-radius: 4px;
		border: 1px solid var(--menu-border-color);

		height: 300px;
		overflow-y: scroll;

	}
	
	#changelog-wrapper::after{

		box-shadow: inset 3px 3px 3px rgba(0, 0, 0, 0.15);
		content: "";
		background-color: transparent;
	
		width: 100%;
		height: 100%;
		position: absolute;
		top: 0;
		left: 0;

		z-index: 999;
		
		pointer-events: none;

	}

	.headline {

		font-size: 32px;
		font-weight: 800;
		line-height: 38px;
		margin: 20px 0px 20px 0px;
		display: block;

		margin-bottom: 20px;

		
	}

	.versionnumber {

		font-size: 10px;
		font-weight: 300;
		line-height: 14px;

		opacity: 60%;
		
		vertical-align:top;

		border-top: 5px solid transparent;
		box-sizing: border-box;

		padding-left: 8px;
		display: inline-block;
	}
	
	#changelog .headline {

		border-top: 16px solid var(--changelog-background);

		font-size: 18px;
		line-height: 22px;
		margin: 0px 0 8px 0; 

		display: block;
		background-color: color-mix(in oklab, var(--menu-background), white 20%) ;

		
		position: sticky;
		top: 0;

	}

	#changelog p:has(+ li) {

		margin-bottom: 2px;

	}

    li {

        list-style-type: none;
        padding-top: 3px;
		padding-left: 20px;
    }

	li.changelogList{

		list-style-type: disc;
		padding-top: 0;
		text-indent: -15px;
		padding-left: 40px

	}

	li.changelogList.level2{

		list-style-type: circle;
		text-indent: -18px;
		padding-left: 58px;
		padding-top: 0;

	}

	.shortcut {

		display: none;

	}

	.explanation {

		font-size: 11px;
		line-height: 14px;
		margin-left: 21px;
		margin-top: -2px;
		display: block;

		font-style: italic;
		opacity: 60%;

	}

	label:hover .shortcut {

		display: inline;

	}

	.dialogBottomButtonRow {

		position: absolute;
		bottom: 20px;
		right: 20px;

	}

	button{

		font-size: 13px;

	}

	button:hover{

		border: initial !important;
		border-radius: 4px !important; 
		padding: 2px 8px 3px 8px;
		border-radius: inherit !important; 
		background-color: var(--menu-hover-color);
		color: white;
		/* pointer-events: none; */

	}

	hr {

		opacity: 50%;
		margin: 0 40px;
		mix-blend-mode: multiply;

	}

	ul {

		margin-top: 0px;
		margin-bottom: 0px;

	}

	code {

		font-family: monospace;

		background-color: color-mix(in oklab, var(--menu-background), black 5%) ;
		border: 1px solid color-mix(in oklab, var(--menu-background), black 10%) ;
		/* color: white; */
		padding: 0px 4px 1px 4px;
		border-radius: 3px;

	}


</style>

			<script>
				
		window.addEventListener("blur", function (){
			if (typeof temporarilyDisableClose !== 'undefined' && temporarilyDisableClose == true) {
				temporarilyDisableClose = false
				return
			}
			Beat.call("Beat.custom.closeSecondWindow()")
		})
				var pageData = false
			</script>
		</body>
	
	</body>
</html>
